
/**
 * Deps.
 */

var slice = Array.prototype.slice;
var Message = require('amp-message');
var crypto = require('crypto');
var debug = require('debug')('axon:sock');


/**
 * Security plugin.
 *
 * Provides a `pack` method which will
 * write the `msg` encrypetd.
 *
 * @param {Object} socket
 * @api private
 */

module.exports = function(socket){

  /**
   * Encrypt a message
   * @param {Buffer} message The message to encrypt
   * @param {String} [secret = 'secret'] The shared secret password use to encrypt all messages
   * @return {Buffer} The encrypted message
   * @ignore
   */

  function encrypt( message, secret ) {
    debug('encrypt message %s with %s length %s ',message, secret, Buffer.from(secret).length );
    let iv = crypto.randomBytes(16);
    let _cipher = crypto.createCipheriv('aes-256-cbc', new Buffer(secret), iv);
    return Buffer.concat([ iv,_cipher.update(message), _cipher.final() ]);
  }
  /**
   * Decrypt a message
   * @param {Buffer} message The encrypted message
   * @param {String} [secret = 'secret'] The shared secret password use to encrypt all messages
   * @return {Buffer} The decrypted buffer
   * @ignore
   */

  function decrypt(message, secret) {
    debug('decrypt message %s with %s ', message.toString(), secret );
    let iv = message.slice(0, 16);
    let encryptedText = message.slice(16,message.length+1);
    let decipher = crypto.createDecipheriv('aes-256-cbc', new Buffer(secret), iv);
    return Buffer.concat([decipher.update(encryptedText), decipher.final()]);
  }

  return function(sock){
    if (socket.get('secure')) {
      var secret = socket.get('secret');

      /**
       * Creates a new encrypted `Message` and write the `args`.
       *
       * @param {Array} args
       * @return {Buffer}
       * @api private
       */

      sock.pack = function (args){
        var msg = new Message(args);
        var buf = msg.toBuffer();
        var secure_buf = [encrypt(buf, secret)];
        var secure_msg = new Message(secure_buf);
        return secure_msg.toBuffer();
      };

      /**
       * Decrypt the message and return the array with all arguments.
       *
       * @param {Buffer} sbuf
       * @return {Array}
       * @api private
       */

      sock.unpack = function (sbuf){
        var secure_msg = new Message(sbuf);
        var secure_buf = secure_msg.args[0];
        var buf = decrypt(secure_buf, secret);
        var msg = new Message(buf);
        return msg.args;
      };
    }
  };
};
